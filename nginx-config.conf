# Configuration Nginx pour SIG Kédougou PWA
# Place this in: /etc/nginx/sites-available/sig-kedougou

upstream php_backend {
    server unix:/run/php/php-fpm.sock;
}

# Redirection HTTP vers HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name sig-kedougou.local localhost;
    
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# Configuration HTTPS (en production)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name sig-kedougou.local;
    
    # SSL Configuration (Let's Encrypt)
    # Générer avec: certbot certonly --nginx -d sig-kedougou.local
    ssl_certificate /etc/letsencrypt/live/sig-kedougou.local/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sig-kedougou.local/privkey.pem;
    
    # SSL Security
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # Sécurité
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # Content Security Policy
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com;
        img-src * data: blob:;
        font-src 'self' data: cdnjs.cloudflare.com;
        connect-src 'self' https://tile.openstreetmap.org https://server.arcgisonline.com;
        media-src 'self';
        object-src 'none';
        frame-ancestors 'self';" always;
    
    # Racine du document
    root /var/www/sig-kedougou;
    index index.html index.htm;
    
    # Accès aux logs
    access_log /var/log/nginx/sig-kedougou_access.log;
    error_log /var/log/nginx/sig-kedougou_error.log;
    
    # Service Worker - Ne pas mettre en cache
    location ~ ^/sw\.js$ {
        try_files $uri =404;
        add_header Content-Type "application/javascript" always;
        add_header Service-Worker-Allowed "/" always;
        add_header Cache-Control "max-age=0, no-cache, no-store, must-revalidate" always;
    }
    
    # Manifest - Mettre en cache 1 heure
    location ~ ^/manifest\.json$ {
        try_files $uri =404;
        add_header Content-Type "application/json; charset=UTF-8" always;
        add_header Cache-Control "max-age=3600, public" always;
    }
    
    # Icônes - Mettre en cache 1 mois
    location ~ ^/icons/ {
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
    }
    
    # Assets (CSS, JS) - Mettre en cache 1 semaine
    location ~ \.(css|js|svg)$ {
        try_files $uri =404;
        expires 7d;
        add_header Cache-Control "public, immutable" always;
        gzip on;
        gzip_types text/css application/javascript image/svg+xml;
    }
    
    # Images - Mettre en cache 30 jours
    location ~ \.(png|jpg|jpeg|gif|webp|ico)$ {
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable" always;
    }
    
    # Données (GeoJSON) - Mettre en cache 1 jour
    location ~ \.(js|geojson|json)$ {
        try_files $uri =404;
        expires 1d;
        add_header Cache-Control "public" always;
        gzip on;
        gzip_types application/json;
    }
    
    # HTML - Ne pas mettre en cache
    location ~ \.html?$ {
        try_files $uri =404;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }
    
    # Route par défaut pour SPA
    location / {
        try_files $uri $uri/ /index.html;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }
    
    # Bloquer l'accès à certains fichiers
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Compression Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/json application/xml+rss;
    
    # Client Body Size (uploads)
    client_max_body_size 100M;
    
    # Timeouts
    client_connect_timeout 60s;
    client_send_timeout 60s;
    client_body_timeout 60s;
}

# Configuration HTTP (développement local)
server {
    listen 8080;
    listen [::]:8080;
    server_name localhost 127.0.0.1;
    
    root /var/www/sig-kedougou;
    index index.html index.htm;
    
    access_log /var/log/nginx/sig-kedougou_dev_access.log;
    error_log /var/log/nginx/sig-kedougou_dev_error.log debug;
    
    # Headers PWA (même en développement)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # Service Worker
    location ~ ^/sig-kedougou/sw\.js$ {
        add_header Service-Worker-Allowed "/" always;
        add_header Cache-Control "no-cache" always;
    }
    
    # Manifest
    location ~ ^/sig-kedougou/manifest\.json$ {
        add_header Content-Type "application/json; charset=UTF-8" always;
        add_header Cache-Control "no-cache" always;
    }
    
    # Route par défaut
    location /sig-kedougou {
        try_files $uri $uri/ /sig-kedougou/index.html;
    }
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # Bloquer l'accès aux fichiers sensibles
    location ~ /\. {
        deny all;
    }
    
    # Compression
    gzip on;
    gzip_types text/plain text/css application/javascript application/json;
}
